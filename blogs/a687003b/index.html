<!DOCTYPE html>
<html lang="">
  <head><meta name="generator" content="Hexo 3.8.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="多版本CUDA和TensorFlow共存">




  <meta name="keywords" content="TensorFlow, CUDA, Gai's Blog">





  <meta name="google-site-verification" content="SrSETrQ8JjhGYLB-qHgsT23NdViq-VEpvghPoNFdn2g">






  <link rel="alternate" href="/atom.xml" title="Gai's Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.9.0">



<link rel="canonical" href="https://bluesmilery.github.io/blogs/a687003b/">



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css">




  <link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css">



<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.9.0">



  
  <script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?a3f2fd48827f9ed28f8d9432317653de";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-121307266-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-121307266-1');
</script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>





  <script src="//cdn1.lncld.net/static/js/3.1.1/av-min.js"></script>
  <script id="leancloud">
    AV.init({
      appId: "BmUgD1geFKBFQpURVdGNzgl1-gzGzoHsz",
      appKey: "mOzxpdEEenjouuAKMFPazvnd"
    });
  </script>




<script>
  window.config = {"title":"Gai's Blog","subtitle":"A Zone for Knowledge","description":null,"author":"Gai","language":null,"timezone":null,"url":"https://bluesmilery.github.io","root":"/","permalink":"blogs/:abbrlink/","permalink_defaults":null,"source_dir":"source","public_dir":"public","tag_dir":"tags","archive_dir":"archives","category_dir":"categories","code_dir":"downloads/code","i18n_dir":":lang","skip_render":null,"new_post_name":":year-:month-:day-:title.md","default_layout":"post","titlecase":false,"external_link":true,"filename_case":0,"render_drafts":false,"post_asset_folder":false,"relative_link":false,"future":true,"highlight":{"enable":true,"auto_detect":false,"line_number":true,"tab_replace":null,"first_line_number":"always1"},"default_category":"uncategorized","category_map":null,"tag_map":null,"date_format":"YYYY-MM-DD","time_format":"HH:mm:ss","per_page":10,"pagination_dir":"page","theme":"even","deploy":[{"type":"git","repo":"git@github.com:bluesmilery/bluesmilery.github.io.git","branch":"master"},{"type":"baidu_url_submitter"}],"ignore":[],"keywords":null,"index_generator":{"per_page":10,"order_by":"-date","path":""},"sitemap":{"path":"sitemap.xml"},"baidusitemap":{"path":"baidusitemap.xml"},"abbrlink":{"alg":"crc32","rep":"hex"},"baidu_url_submit":{"count":1,"host":"bluesmilery.github.io","token":"cktimjuXHORRMXsM","path":"baidu_urls.txt"},"archive_generator":{"per_page":10,"yearly":true,"monthly":true,"daily":false},"category_generator":{"per_page":10},"feed":{"type":"atom","limit":20,"hub":"","content":true,"content_limit":140,"content_limit_delim":"","path":"atom.xml"},"marked":{"gfm":true,"pedantic":false,"sanitize":false,"tables":true,"breaks":true,"smartLists":true,"smartypants":true,"modifyAnchors":"","autolink":true},"tag_generator":{"per_page":10},"server":{"port":4000,"log":false,"compress":false,"header":true},"since":2017,"favicon":"/favicon.ico","rss":"default","menu":{"Home":"/","Archives":"/archives/","Tags":"/tags","Categories":"/categories"},"color":"Default","toc":true,"fancybox":true,"pjax":true,"copyright":{"enable":true,"license":"<a rel=\"license\" href=\"http://creativecommons.org/licenses/by-nc/4.0/\" target=\"_blank\">知识共享署名-非商业性使用 4.0 国际许可协议</a>"},"reward":{"enable":false,"qrCode":{"wechat":null,"alipay":null}},"social":{"email":"plgaixd92498@gmail.com","stack-overflow":null,"twitter":null,"facebook":null,"linkedin":null,"google":null,"github":"https://github.com/bluesmilery","weibo":null,"zhihu":null,"douban":null,"pocket":null,"tumblr":null,"instagram":null},"leancloud":{"app_id":"BmUgD1geFKBFQpURVdGNzgl1-gzGzoHsz","app_key":"mOzxpdEEenjouuAKMFPazvnd"},"baidu_analytics":"a3f2fd48827f9ed28f8d9432317653de","baidu_verification":null,"google_analytics":"UA-121307266-1","google_verification":"SrSETrQ8JjhGYLB-qHgsT23NdViq-VEpvghPoNFdn2g","disqus_shortname":null,"changyan":{"appid":null,"appkey":null},"livere_datauid":"MTAyMC8zMzY4MC8xMDIzNQ","version":"2.9.0","word_count":true};
</script>

    <title> 多版本CUDA和TensorFlow共存 - Gai's Blog </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Gai's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            分类
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Gai's Blog</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          多版本CUDA和TensorFlow共存
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-06-17
        </span>
        
          <div class="post-category">
            
              <a href="/categories/技术/">技术</a>
            
          </div>
        
        
        <div class="post-visits" data-url="/blogs/a687003b/" data-title="多版本CUDA和TensorFlow共存">
            阅读次数 0
          </div>
        
        
        
        
          <span class="post-count">本文共4.6k字</span>
          <span class="post-count">阅读约19分钟</span>
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#使用方法"><span class="toc-text">使用方法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#安装过程"><span class="toc-text">安装过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、安装显卡驱动"><span class="toc-text">1、安装显卡驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#下载"><span class="toc-text">下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装"><span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证是否支持低版本CUDA"><span class="toc-text">验证是否支持低版本CUDA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一些错误"><span class="toc-text">一些错误</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、安装CUDA-9-0-amp-cuDNN-7-1"><span class="toc-text">2、安装CUDA-9.0 &amp; cuDNN-7.1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CUDA下载"><span class="toc-text">CUDA下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CUDA安装"><span class="toc-text">CUDA安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CUDA测试"><span class="toc-text">CUDA测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cuDNN下载"><span class="toc-text">cuDNN下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cuDNN安装"><span class="toc-text">cuDNN安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#注意"><span class="toc-text">注意</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、安装Anaconda"><span class="toc-text">3、安装Anaconda</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#下载安装"><span class="toc-text">下载安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改国内镜像仓库"><span class="toc-text">修改国内镜像仓库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建虚拟环境"><span class="toc-text">创建虚拟环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动和退出虚拟环境"><span class="toc-text">启动和退出虚拟环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其他常用指令"><span class="toc-text">其他常用指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#多版本TensorFlow共存"><span class="toc-text">多版本TensorFlow共存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置全局pip源配置"><span class="toc-text">设置全局pip源配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一些错误-1"><span class="toc-text">一些错误</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4、给虚拟环境指定CUDA版本"><span class="toc-text">4、给虚拟环境指定CUDA版本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#处理环境变量"><span class="toc-text">处理环境变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试"><span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5、小结"><span class="toc-text">5、小结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#注意事项"><span class="toc-text">注意事项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-text">Reference</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#create-virtual-env-sh"><span class="toc-text">create_virtual_env.sh</span></a></li></ol>
    </div>
  </div>



    <div class="post-content">
      
        <p>直奔主题，为什么要做这件事情？</p>
<ul>
<li>服务器目前安装了CUDA 8.0、TensorFlow 1.3.0，并已有线上服务基于该版本环境配置开发，无法轻易修改本机环境版本</li>
<li>TensorFlow版本迭代很快，新版本使用更高版本的CUDA，不仅计算速度上更快，而且还有一些更加丰富的API可供使用，例如TensorFlow 1.8.0版本中的eager模式</li>
</ul>
<p>所以通过查资料以及实验完成了这件事情，并记录下来以供有同样需求的朋友参考</p>
<p>文章修改记录：</p>
<table>
<thead>
<tr>
<th>时间</th>
<th>修改内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>2018.11.25</td>
<td>统一路径信息、修改部分链接、增加全局pip源设置以及一些小问题修复</td>
</tr>
<tr>
<td></td>
</tr>
</tbody>
</table>
<a id="more"></a>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>文章开头说了为什么要做这件事，所以其实本质就是为了在不改变原有版本的基础上能够使用新版本，那么便需要调研多版本共存的可行性</p>
<p>经过调研，CUDA和TensorFlow均可以做到多版本共存，障碍只剩一个——显卡驱动。因为目前的显卡驱动384.66是支持CUDA 8.0的最新版本驱动，然而其不支持更高版本的CUDA。所以考虑使用支持更高版本CUDA的显卡驱动，并测试其是否向下兼容低版本CUDA。测试结果是可行的，这也才有了这篇文章</p>
<p>整篇文章分为两部分：使用方法、安装过程</p>
<ul>
<li>使用方法是将安装过程中创建虚拟环境并配置的过程使用脚本实现，以达到一步到位的便捷使用。脚本内容可以见文后</li>
<li>安装过程叙述了为了达成多版本共存的目的所做的一些操作或者配置</li>
</ul>
<p>本文所使用的Anaconda软件以root权限安装在<code>/home/anaconda3</code>目录下，可根据需要自行修改。安装后服务器上所有用户均可使用Anaconda来创建虚拟环境</p>
<p>本文由 @李君阳 与我一同完成</p>
<h1 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h1><p>若要创建指定CUDA版本的虚拟环境，请运行 <strong>create_virtual_env.sh</strong> 脚本（见文末），根据提示输入虚拟环境名称、Python版本、CUDA版本即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Enter the name of Anaconda virtual environment: </span><br><span class="line">Enter the version of Python (default is 3.6.5):</span><br><span class="line">Enter the version of CUDA (8.0/9.0, default is 9.0):</span><br><span class="line">Start to create the environment......</span><br></pre></td></tr></table></figure>
<p>创建完成后会显示 Everything is DONE!</p>
<p>随后使用<code>source activate XXX(或者conda activate XXX)</code>命令进入虚拟环境，在虚拟环境中可以使用创建时指定的Python版本和CUDA版本，可自由使用pip安装自己所需要的Python包，不影响本机环境</p>
<p>要回到本机环境使用<code>source deactivate(或者conda deactivate)</code>退出虚拟环境</p>
<h1 id="安装过程"><a href="#安装过程" class="headerlink" title="安装过程"></a>安装过程</h1><h2 id="1、安装显卡驱动"><a href="#1、安装显卡驱动" class="headerlink" title="1、安装显卡驱动"></a>1、安装显卡驱动</h2><p>目前服务器上安装的显卡驱动版本为384.66，是支持CUDA 8.0的最新版本驱动。目前已知该驱动无法支持更高版本的CUDA，所以需要验证安装支持高版本CUDA的显卡驱动是否能正常向下兼容低版本CUDA</p>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>去 <a href="http://www.nvidia.cn/Download/index.aspx" target="_blank" rel="noopener">http://www.nvidia.cn/Download/index.aspx</a> 这里寻找对应的显卡驱动即可，这里选择：</p>
<ul>
<li>Product Type: Tesla</li>
<li>Product Series: M-Series</li>
<li>Product: M40 24GB</li>
<li>Operating System: Linux 64-bit</li>
<li>CUDA Toolkit: 9.1</li>
<li>Language: English(US)</li>
</ul>
<p>这里下载的文件名是：NVIDIA-Linux-x86_64-390.46.run</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>首先先卸载旧版本驱动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./NVIDIA-Linux-x86_64-384.66.run --uninstall</span><br></pre></td></tr></table></figure>
<p>然后对新驱动添加可执行权限，安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod u+x NVIDIA-Linux-x86_64-390.46.run</span><br><span class="line">./NVIDIA-Linux-x86_64-390.46.run</span><br></pre></td></tr></table></figure>
<p>进入安装界面后一路同意就可以</p>
<h3 id="验证是否支持低版本CUDA"><a href="#验证是否支持低版本CUDA" class="headerlink" title="验证是否支持低版本CUDA"></a>验证是否支持低版本CUDA</h3><p>使用CUDA自带的samples进行验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/cuda-8.0/samples/1_Utilities/deviceQuery</span><br><span class="line">make clean</span><br><span class="line">make</span><br><span class="line">./deviceQuery</span><br></pre></td></tr></table></figure>
<p>如果在最后看到以下信息，则证明该驱动能够支持低版本CUDA</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">deviceQuery, CUDA Driver = CUDART, CUDA Driver Version = 9.1, CUDA Runtime Version = 8.0, NumDevs = 2, Device0 = Tesla M40 24GB, Device1 = Tesla M40 24GB</span><br><span class="line">Result = PASS</span><br></pre></td></tr></table></figure>
<h3 id="一些错误"><a href="#一些错误" class="headerlink" title="一些错误"></a>一些错误</h3><ul>
<li>ERROR: An NVIDIA kernel module ‘nvidia-uvm’ appears to already be loaded in your kernel.  This may be because it is in use (for example, by an X server, a CUDA program, or the NVIDIA Persistence Daemon), but this may also happen if your kernel was configured without support for module unloading.  Please be sure to exit any programs that may be using the GPU(s) before attempting to upgrade your driver.  If no GPU-based programs are running, you know that your kernel supports module unloading, and you still receive this message, then an error may have occured that has corrupted an NVIDIA kernel module’s usage count, for which the simplest remedy is to reboot your computer.</li>
</ul>
<p>使用nvidia-smi命令查看有哪些程序在使用显卡，kill掉。如果没有使用显卡的程序依旧报错，可以重启服务器</p>
<ul>
<li>其他错误参考另外两篇文章<a href="https://bluesmilery.github.io/blogs/9ef0e127/">文章1</a>、<a href="https://bluesmilery.github.io/blogs/77f7532c/">文章2</a></li>
</ul>
<h2 id="2、安装CUDA-9-0-amp-cuDNN-7-1"><a href="#2、安装CUDA-9-0-amp-cuDNN-7-1" class="headerlink" title="2、安装CUDA-9.0 &amp; cuDNN-7.1"></a>2、安装CUDA-9.0 &amp; cuDNN-7.1</h2><h3 id="CUDA下载"><a href="#CUDA下载" class="headerlink" title="CUDA下载"></a>CUDA下载</h3><p>注意：目前CUDA最新版本为9.1，但是TensorFlow的最新版本1.8还未支持CUDA 9.1，所以只能安装CUDA 9.0</p>
<p>去 <a href="https://developer.nvidia.com/cuda-downloads" target="_blank" rel="noopener">https://developer.nvidia.com/cuda-downloads</a> 这里寻找对应平台的文件下载即可。进入后默认显示最新版本CUDA，选择靠右侧的Legacy Releases，进入后选择<a href="https://developer.nvidia.com/cuda-90-download-archive" target="_blank" rel="noopener">CUDA Toolkit 9.0</a> (Sept 2017)</p>
<p>这里一些选项的选择为：</p>
<ul>
<li>Operating System: Linux</li>
<li>Architecture: x86_64</li>
<li>Distribution: CentOS</li>
<li>Version: 7</li>
<li>Installer Type: runfile(local)</li>
</ul>
<p>下面会显示两个安装文件，一个 Base Installer ，两个Patch。安装完Base后再安装Patch即可</p>
<p>直接复制下载链接，在服务器上wget下载即可</p>
<h3 id="CUDA安装"><a href="#CUDA安装" class="headerlink" title="CUDA安装"></a>CUDA安装</h3><p>添加可执行权限，安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod u+x cuda_9.0.176_384.81_linux.run</span><br><span class="line">./cuda_9.0.176_384.81_linux.run</span><br></pre></td></tr></table></figure>
<p>接下来会有一系列选择</p>
<ul>
<li>是否安装显卡驱动：选no，因为已经装了最新的驱动</li>
<li>是否安装CUDA 9.0：选yes</li>
<li>输入安装位置：默认即可，因为默认位置就区分开了不同的CUDA版本</li>
<li>是否创建软链：选no，因为要实现多版本CUDA共存。如果以前安装过CUDA并创建过软链，需要删除</li>
<li>是否安装sample：选no，因为在安装路径下会有一份sample，这个是问是否要在自己的目录下再安装一份</li>
</ul>
<p>然后再安装一下两个补丁即可：cuda_9.0.176.1_linux.run、cuda_9.0.176.2_linux.run</p>
<h3 id="CUDA测试"><a href="#CUDA测试" class="headerlink" title="CUDA测试"></a>CUDA测试</h3><p>进入samples目录，选择第一个例子进行测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/cuda-9.0/samples/1_Utilities/deviceQuery</span><br><span class="line">make</span><br><span class="line">./deviceQuery</span><br></pre></td></tr></table></figure>
<p>如果在最后看到以下信息，则证明CUDA 9.0安装成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">deviceQuery, CUDA Driver = CUDART, CUDA Driver Version = 9.1, CUDA Runtime Version = 9.0, NumDevs = 2</span><br><span class="line">Result = PASS</span><br></pre></td></tr></table></figure>
<h3 id="cuDNN下载"><a href="#cuDNN下载" class="headerlink" title="cuDNN下载"></a>cuDNN下载</h3><p>去 <a href="https://developer.nvidia.com/rdp/cudnn-download" target="_blank" rel="noopener">https://developer.nvidia.com/rdp/cudnn-download</a> 选择对应的版本下载即可。不过需要先注册开发者账号后才可以下载</p>
<p>刚才安装的CUDA是9.0，所以我们选择</p>
<ul>
<li>Download cuDNN v7.1.3 (April 17, 2018), for CUDA 9.0</li>
<li>cuDNN v7.1.3 Library for Linux</li>
</ul>
<h3 id="cuDNN安装"><a href="#cuDNN安装" class="headerlink" title="cuDNN安装"></a>cuDNN安装</h3><p>执行解压操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir cuda-9.0_cudnn</span><br><span class="line">tar zxvf cudnn-9.0-linux-x64-v7.1.tgz -C ./cuda-9.0_cudnn</span><br><span class="line"><span class="built_in">cd</span> cuda-9.0_cudnn</span><br></pre></td></tr></table></figure>
<p>解压后的文件夹是cuda。执行以下操作把文件复制到相应的位置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp cuda/include/cudnn.h /usr/<span class="built_in">local</span>/cuda-9.0/include/</span><br><span class="line">cp cuda/lib64/libcudnn* /usr/<span class="built_in">local</span>/cuda-9.0/lib64/</span><br><span class="line">chmod a+r /usr/<span class="built_in">local</span>/cuda-9.0/include/cudnn.h</span><br><span class="line">chmod a+r /usr/<span class="built_in">local</span>/cuda-9.0/lib64/libcudnn*</span><br></pre></td></tr></table></figure>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>以上过程基于服务器上已经有一个CUDA版本。如果服务器上未安装过CUDA，按照这个过程依次安装两个版本CUDA即可，只需注意不要创建软链。如果打算在本机环境使用CUDA，则需要配置环境变量。如果打算都在虚拟python环境下运行，则本机不需要配置相关环境变量，在之后启动虚拟环境时配置</p>
<h2 id="3、安装Anaconda"><a href="#3、安装Anaconda" class="headerlink" title="3、安装Anaconda"></a>3、安装Anaconda</h2><h3 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h3><p>使用该<a href="https://repo.anaconda.com/archive/Anaconda3-5.1.0-Linux-x86_64.sh" target="_blank" rel="noopener">下载链接</a>下载Anaconda安装脚本，默认Python版本是3.6.5</p>
<p>添加可执行权限后，执行安装</p>
<p>安装完一堆包之后会询问是否要添加环境变量，这里选择no，稍后再添加。然后会继续询问是否安装VSCode，选择no。此时安装完成</p>
<p>因为我们使用Anaconda只是作为虚拟python环境管理，不需要用到其自带的python以及相关包，所以需要将Anaconda的bin放到path后，否则系统的python会失效。所以将下面这一行添加到需要使用Anaconda账户的<code>.bashrc</code>文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=$PATH:/home/anaconda3/bin</span><br></pre></td></tr></table></figure>
<p>source一下或者退出重新登陆</p>
<p>然后执行<code>ln -s /home/anaconda3/etc/profile.d/conda.sh /etc/profile.d/conda.sh</code>，这是为了服务器上所有用户都可以使用<code>conda activate</code>和<code>conda deactivate</code>来进入和退出虚拟环境（即source和conda都可以）</p>
<h3 id="修改国内镜像仓库"><a href="#修改国内镜像仓库" class="headerlink" title="修改国内镜像仓库"></a>修改国内镜像仓库</h3><p>因为Anaconda默认使用国外的下载地址，为了提高国内的下载速度，可以使用国内的清华镜像源或者中科大镜像源，二选一即可，执行三条命令</p>
<p>加入–system是配置全局的conda config。若个人账户想修改，则取消–system即可，此时在个人账户下会覆盖全局配置（类似 git config ）。个人账号相关配置会写在 ~/.condarc 里面</p>
<ul>
<li>清华Anaconda镜像</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">conda config --system --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</span><br><span class="line">conda config --system --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/</span><br><span class="line">conda config --system --<span class="built_in">set</span> show_channel_urls yes</span><br></pre></td></tr></table></figure>
<ul>
<li>中科大Anaconda镜像</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">conda config --system --add channels http://mirrors.ustc.edu.cn/anaconda/pkgs/free/</span><br><span class="line">conda config --system --add channels http://mirrors.ustc.edu.cn/anaconda/pkgs/main/</span><br><span class="line">conda config --system --<span class="built_in">set</span> show_channel_urls yes</span><br></pre></td></tr></table></figure>
<h3 id="创建虚拟环境"><a href="#创建虚拟环境" class="headerlink" title="创建虚拟环境"></a>创建虚拟环境</h3><p>基本命令为 <code>conda create --name XXX</code>，–name可缩写为-n</p>
<p>如果在创建虚拟环境时报错（跟urls.txt或者environments.txt有关，一般是第一次使用Anaconda时会出现），参考下方一些错误部分</p>
<p>关于创建虚拟环境，分以下三种情况陈述</p>
<ul>
<li><code>conda create --name test1</code></li>
</ul>
<p>此时虚拟环境并不起作用，进入test1后会发现实际上使用的依旧是本机Python环境，并且在test1中使用pip安装或者删除包均是对本机环境操作</p>
<p>所以不要使用这种方式</p>
<ul>
<li><code>conda create --name test2 python=X.X.X</code></li>
</ul>
<p>该命令会创建一个名为test2的纯净虚拟环境，并且会安装python X.X.X版本，无其他Python包。进入test2后，使用<code>python -V</code>和<code>pip -V</code>可以看到使用的的确是该虚拟环境，并且在test2中使用pip安装或者删除包均是对该虚拟环境进行操作，不会影响本机环境</p>
<p>这里python的入参有多种</p>
<p>如果只写python，则安装的是Anaconda自带的Python版本（在这里是3.6.5）</p>
<p>如果是python=2或者python=3，则安装的是python2或者python3的最新版本（目前是2.7.15和3.6.5）</p>
<p>如果写了二级版本号，例如python=2.6或者python=3.5，则安装的是python2.6或者python3.5分支的最新版本（目前是2.6.9和3.5.5）</p>
<p>如果写了最小的版本号，例如python=2.7.8或者python=3.6.2，则安装的便是输入的特定版本</p>
<ul>
<li><code>conda create --name test3 python=2.7 numpy</code></li>
</ul>
<p>该命令会创建一个名为test3的纯净虚拟环境，并且会安装python2.7的最新版本，在此基础上还会额外安装numpy包。当然numpy包也可以类似Python一样指定版本，例如numpy=1.10，则会安装1.10.4版本。不指定则安装的就是最新版本。其他同上</p>
<ul>
<li><code>conda create --name test4 numpy</code></li>
</ul>
<p>该命令会创建一个名为test4的纯净虚拟环境，并且会安装Anaconda自带的Python版本（在这里是3.6.5），在此基础上还会额外安装numpy包。其他同上</p>
<h3 id="启动和退出虚拟环境"><a href="#启动和退出虚拟环境" class="headerlink" title="启动和退出虚拟环境"></a>启动和退出虚拟环境</h3><ul>
<li>启动</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> activate XXX(或者conda activate XXX)</span><br></pre></td></tr></table></figure>
<p>启动成功后在命令行前会有虚拟环境的名字（XXX）</p>
<ul>
<li>退出</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> deactivate(或者conda deactivate)</span><br></pre></td></tr></table></figure>
<h3 id="其他常用指令"><a href="#其他常用指令" class="headerlink" title="其他常用指令"></a>其他常用指令</h3><p>查看有哪些虚拟环境：<code>conda env list</code></p>
<p>删除虚拟环境：<code>conda env remove -n XXX</code></p>
<h3 id="多版本TensorFlow共存"><a href="#多版本TensorFlow共存" class="headerlink" title="多版本TensorFlow共存"></a>多版本TensorFlow共存</h3><p>在不同的虚拟环境中安装不同版本的TensorFlow即可。若不同版本的TensorFlow依赖的CUDA版本不同，则参照下一小节“给虚拟环境指定CUDA版本”来操作</p>
<h3 id="设置全局pip源配置"><a href="#设置全局pip源配置" class="headerlink" title="设置全局pip源配置"></a>设置全局pip源配置</h3><p>进入到虚拟环境后，使用pip安装Python包的时候会发现其从原始的国外地址进行下载。有时下载速度较慢，所以我们要更新pip源为国内源</p>
<p>编辑 <code>/etc/pip.conf</code>文件（若无则创建），添加以下内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">trusted-host = mirrors.aliyun.com</span><br><span class="line">index-url = http://mirrors.aliyun.com/pypi/simple</span><br></pre></td></tr></table></figure>
<p>该方式可以进行全局pip源配置，便于服务器上所有用户均可使用。若只要某些用户使用，那么编辑的就是<code>~/.pip/pip.conf</code>文件</p>
<h3 id="一些错误-1"><a href="#一些错误-1" class="headerlink" title="一些错误"></a>一些错误</h3><ul>
<li><p>NotWritableError: The current user does not have write permissions to a required path.</p>
<p>path: /home/username/.conda/pkgs/urls.txt</p>
<p>uid: 1001</p>
<p>gid: 1002</p>
<p>If you feel that permissions on this path are set incorrectly, you can manually change them by executing</p>
<p>$ sudo chown 1001:1002 /home/username/.conda/pkgs/urls.txt</p>
<p>In general, it’s not advisable to use ‘sudo conda’.</p>
</li>
</ul>
<p>自己创建该文件。类似的还有 <code>/home/username/.conda/environments.txt</code></p>
<h2 id="4、给虚拟环境指定CUDA版本"><a href="#4、给虚拟环境指定CUDA版本" class="headerlink" title="4、给虚拟环境指定CUDA版本"></a>4、给虚拟环境指定CUDA版本</h2><h3 id="处理环境变量"><a href="#处理环境变量" class="headerlink" title="处理环境变量"></a>处理环境变量</h3><p>假设此时服务器上安装了两个CUDA版本，分别为CUDA 8.0（/usr/local/cuda-8.0）和CUDA 9.0（/usr/local/cuda-9.0），并且在本机上配置了一个版本（例如8.0）的环境变量（$CUDA_HOME, $LD_LIBRARY_PATH）。没配置更好，这里配置是为了验证切换虚拟环境时指定的CUDA版本是否发生相应的改变</p>
<p>首先创建一个虚拟环境，让这个虚拟环境使用CUDA 9.0的lib</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda create -n cuda_test python=3</span><br></pre></td></tr></table></figure>
<p>然后设定启动虚拟环境以及退出时需要执行的脚本，为了使虚拟环境启动时环境变量不同于本机环境，退出时又恢复为本机环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/username/.conda/envs/cuda_test/etc/conda/activate.d</span><br><span class="line">mkdir -p /home/username/.conda/envs/cuda_test/etc/conda/deactivate.d</span><br></pre></td></tr></table></figure>
<ul>
<li>编辑启动脚本 <code>vim /home/username/.conda/envs/cuda_test/etc/conda/activate.d/activate.sh</code></li>
</ul>
<p>输入以下内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ORIGINAL_CUDA_HOME=$CUDA_HOME</span><br><span class="line">ORIGINAL_LD_LIBRARY_PATH=$LD_LIBRARY_PATH</span><br><span class="line">export CUDA_HOME=/usr/local/cuda-9.0</span><br><span class="line">export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH</span><br></pre></td></tr></table></figure>
<p>添加执行权限 <code>chmod +x /home/username/.conda/envs/cuda_test/etc/conda/activate.d/activate.sh</code></p>
<ul>
<li>编辑退出脚本 <code>vim /home/username/.conda/envs/cuda_test/etc/conda/deactivate.d/deactivate.sh</code></li>
</ul>
<p>输入以下内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export CUDA_HOME=$ORIGINAL_CUDA_HOME</span><br><span class="line">export LD_LIBRARY_PATH=$ORIGINAL_LD_LIBRARY_PATH</span><br><span class="line">unset ORIGINAL_CUDA_HOME</span><br><span class="line">unset ORIGINAL_LD_LIBRARY_PATH</span><br></pre></td></tr></table></figure>
<p>添加执行权限 <code>chmod +x /home/username/.conda/envs/cuda_test/etc/conda/deactivate.d/deactivate.sh</code></p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>首先先在本机查看环境变量 CUDA_HOME 和 LD_LIBRARY_PATH</p>
<p><code>echo $CUDA_HOME</code> 结果为/usr/local/cuda-8.0</p>
<p><code>echo $LD_LIBRARY_PATH</code> 结果为/usr/local/cuda-8.0/lib64</p>
<p>进入虚拟环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> activate cuda_test</span><br></pre></td></tr></table></figure>
<p>查看此时的环境变量 </p>
<p><code>echo $CUDA_HOME</code> 结果为/usr/local/cuda-9.0</p>
<p><code>echo $LD_LIBRARY_PATH</code> 结果为/usr/local/cuda-9.0/lib64:/usr/local/cuda-8.0/lib64</p>
<p>退出虚拟环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> deactivate</span><br></pre></td></tr></table></figure>
<p>再次查看环境变量，会发现恢复为/usr/local/cuda-8.0和/usr/local/cuda-8.0/lib64，证明在虚拟环境中指定CUDA版本lib成功</p>
<p>PS：也可以通过在虚拟环境中安装1.8.0版本的tensorflow-gpu来验证，因为其必须使用CUDA 9.0才能正确import，否则会报错ImportError: libcublas.so.9.0: cannot open shared object file: No such file or directory</p>
<h2 id="5、小结"><a href="#5、小结" class="headerlink" title="5、小结"></a>5、小结</h2><p>至此，完成以上操作后，在服务器上即可达到多版本CUDA、TensorFlow共存的目的</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>通过第四小节可以看到，可以通过编写虚拟环境的启动脚本和退出脚本来管理虚拟环境中的环境变量，使其启动时不同于本机环境，退出时又恢复为本机环境。但是如果需要在脚本中对PATH环境变量做改变的话，会发生一些问题——退出时没有正确恢复PATH环境变量</p>
<p>在对虚拟环境启动和退出的过程做了梳理后，可以有办法解决这个问题（使用上述ORIGINAL_的方式做中间转换是无法解决的）</p>
<p>假设启动前PATH内容为/usr/bin</p>
<p>启动过程：</p>
<ol>
<li>在启动时，conda会先修改PATH，在本机PATH的前面加上<code>/home/username/.conda/envs/cuda_test/bin:</code> ，这是为了在虚拟环境中能够使用虚拟环境自己的Python。此时PATH内容为<code>PATH=/home/username/.conda/envs/cuda_test/bin:/usr/bin</code>，然后export该PATH</li>
<li>然后执行添加的启动脚本activate.sh。假如在其中对PATH做了添加，此时PATH内容为<code>PATH=/xxxx/bin:/home/username/.conda/envs/cuda_test/bin:/usr/bin</code>。进入虚拟环境中echo $PATH得到的内容也是<code>/xxxx/bin:/home/username/.conda/envs/cuda_test/bin:/usr/bin</code></li>
<li>然后conda会将此时的PATH在某个地方备份记录一下，并且将其在第一步添加的内容删掉。也就是说这时conda会保留一个内容为<code>/xxxx/bin:/usr/bin</code>的PATH</li>
</ol>
<p>退出过程：</p>
<ol>
<li>首先执行添加的退出脚本deactivate.sh</li>
<li>将启动第三步存下来的PATH拿出来直接export。所以在deactivate.sh中使用ORIGINAL_的方式做恢复是无效的</li>
</ol>
<p>当恢复到本机环境时，PATH的内容为<code>/xxxx/bin:/usr/bin</code>的PATH，与启动前不一样</p>
<p>启动过程主要执行的是<code>/home/anaconda3/etc/profile.d/conda.sh</code>中的<code>_conda_activate()</code>方法。退出过程主要执行的是<code>/home/anaconda3/etc/profile.d/conda.sh</code>中的<code>_conda_deactivate()</code>方法</p>
<p>目前想到的一种解决方案如下：（未尝试）</p>
<ol>
<li>在退出脚本deactivate.sh的头部添加<code>FIX_PATH=$CUDA_HOME</code></li>
<li>在<code>/home/anaconda3/etc/profile.d/conda.sh</code>的<code>_conda_deactivate()</code>方法中的<code>eval &quot;$ask_conda&quot;</code>之后，在PATH中正则匹配FIX_PATH的内容并将其删掉，再重新export PATH</li>
</ol>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.jianshu.com/p/4ac737fd6b45" target="_blank" rel="noopener">https://www.jianshu.com/p/4ac737fd6b45</a></p>
<p><a href="https://blog.kovalevskyi.com/multiple-version-of-cuda-libraries-on-the-same-machine-b9502d50ae77" target="_blank" rel="noopener">https://blog.kovalevskyi.com/multiple-version-of-cuda-libraries-on-the-same-machine-b9502d50ae77</a></p>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-install-the-anaconda-python-distribution-on-ubuntu-16-04" target="_blank" rel="noopener">https://www.digitalocean.com/community/tutorials/how-to-install-the-anaconda-python-distribution-on-ubuntu-16-04</a></p>
<h1 id="create-virtual-env-sh"><a href="#create-virtual-env-sh" class="headerlink" title="create_virtual_env.sh"></a>create_virtual_env.sh</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Used to create a Anaconda virtual environment <span class="keyword">for</span> CUDA and TensorFlow.</span></span><br><span class="line"></span><br><span class="line">echo ""</span><br><span class="line">echo "This script is used to create a Anaconda virtual environment for CUDA and TensorFlow."</span><br><span class="line"></span><br><span class="line">echo ""</span><br><span class="line">read -p "Enter the name of Anaconda virtual environment: " ENV_NAME</span><br><span class="line">if [ -z $&#123;ENV_NAME&#125; ]; then</span><br><span class="line">    echo ""</span><br><span class="line">    echo "Need a virtual environment name!" &gt;&amp;2</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo ""</span><br><span class="line">read -p "Enter the version of Python (default is 3.6.5): " PYTHON_VERSION</span><br><span class="line">if [ -z $&#123;PYTHON_VERSION&#125; ]; then</span><br><span class="line">    PYTHON_VERSION="3.6.5"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo ""</span><br><span class="line">read -p "Enter the version of CUDA (8.0/9.0, default is 9.0): " CUDA_VERSION</span><br><span class="line">if [ -z $&#123;CUDA_VERSION&#125; ]; then</span><br><span class="line">    CUDA_VERSION="9.0"</span><br><span class="line">elif [ $&#123;CUDA_VERSION&#125; != "8.0" ] &amp;&amp; [ $&#123;CUDA_VERSION&#125; != "9.0" ]; then</span><br><span class="line">    echo ""</span><br><span class="line">    echo "CUDA version must be 8.0 or 9.0!" &gt;&amp;2</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo ""</span><br><span class="line">echo "Start to create the environment......"</span><br><span class="line">echo ""</span><br><span class="line"></span><br><span class="line">cmd_create="conda create -n $&#123;ENV_NAME&#125; python=$&#123;PYTHON_VERSION&#125;"</span><br><span class="line">eval $&#123;cmd_create&#125;</span><br><span class="line"></span><br><span class="line">ACTIVATE_PATH=$HOME/.conda/envs/$&#123;ENV_NAME&#125;/etc/conda/activate.d</span><br><span class="line">DEACTIVATE_PATH=$HOME/.conda/envs/$&#123;ENV_NAME&#125;/etc/conda/deactivate.d</span><br><span class="line"></span><br><span class="line">activate_string="</span><br><span class="line">ORIGINAL_CUDA_HOME=\$CUDA_HOME</span><br><span class="line">ORIGINAL_LD_LIBRARY_PATH=\$LD_LIBRARY_PATH</span><br><span class="line"></span><br><span class="line">export CUDA_HOME=/usr/local/cuda-$CUDA_VERSION</span><br><span class="line">export LD_LIBRARY_PATH=\$CUDA_HOME/lib64:\$LD_LIBRARY_PATH"</span><br><span class="line"></span><br><span class="line">deactivate_string='</span><br><span class="line">export CUDA_HOME=$ORIGINAL_CUDA_HOME</span><br><span class="line">export LD_LIBRARY_PATH=$ORIGINAL_LD_LIBRARY_PATH</span><br><span class="line"></span><br><span class="line">unset ORIGINAL_CUDA_HOME</span><br><span class="line">unset ORIGINAL_LD_LIBRARY_PATH'</span><br><span class="line"></span><br><span class="line">mkdir -p $&#123;ACTIVATE_PATH&#125;</span><br><span class="line">echo "$&#123;activate_string&#125;" &gt; $&#123;ACTIVATE_PATH&#125;/activate.sh</span><br><span class="line">chmod +x $&#123;ACTIVATE_PATH&#125;/activate.sh</span><br><span class="line"></span><br><span class="line">mkdir -p $&#123;DEACTIVATE_PATH&#125;</span><br><span class="line">echo "$&#123;deactivate_string&#125;" &gt; $&#123;DEACTIVATE_PATH&#125;/deactivate.sh</span><br><span class="line">chmod +x $&#123;DEACTIVATE_PATH&#125;/deactivate.sh</span><br><span class="line"></span><br><span class="line">echo "Everything is DONE!"</span><br><span class="line">echo ""</span><br></pre></td></tr></table></figure>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="https://bluesmilery.github.io">Gai</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="https://bluesmilery.github.io/blogs/a687003b/">https://bluesmilery.github.io/blogs/a687003b/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/TensorFlow/">TensorFlow</a>
            
              <a href="/tags/CUDA/">CUDA</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/blogs/6d457259/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">使用Python多进程Pool类时遇见的一些问题</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/blogs/77f7532c/">
        <span class="next-text nav-default">腾讯云GPU服务器搭建TensorFlow开发环境</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMzY4MC8xMDIzNQ">
        <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
      </div>  
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


  <div class="social-links">
    
      
        
          <a href="mailto:plgaixd92498@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/bluesmilery" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  
  <br>
  <span id="busuanzi_container_site_uv">
    被<span id="busuanzi_value_site_uv"></span>个小伙伴
  </span>
  <span id="busuanzi_container_site_pv">
    查看了<span id="busuanzi_value_site_pv"></span>次~
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2017 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Gai</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  

  
   <script type="text/javascript">
	(function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
  </script>




    
  



  
  





  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  
    <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.9.0"></script>

  </body>
</html>
